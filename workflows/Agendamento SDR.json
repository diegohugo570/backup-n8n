{
  "active": false,
  "connections": {
    "AI Message Buffer": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Block Chat Id": {
      "main": [
        [
          {
            "node": "Switch Block",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Block": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Get Buffer Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If no new messages": {
      "main": [
        [
          {
            "node": "Clear Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Buffer Messages": {
      "main": [
        [
          {
            "node": "If no new messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buffer": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Buffer": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "AI Message Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remover From Me": {
      "main": [
        [
          {
            "node": "Bloquear Thread",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Block Chat Id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Follow-Up": {
      "main": [
        [
          {
            "node": "Vari√°veis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vari√°veis": {
      "main": [
        [
          {
            "node": "Execution Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data2": {
      "main": [
        [
          {
            "node": "Remover From Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem de Audio": {
      "main": [
        [
          {
            "node": "Converter √Åudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter √Åudio": {
      "main": [
        [
          {
            "node": "Transcreve √Åudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envio de Imagens": {
      "main": [
        [
          {
            "node": "Converter Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Imagem": {
      "main": [
        [
          {
            "node": "Analisa Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter Arquivo1": {
      "main": [
        [
          {
            "node": "Extrair Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Mensagem de Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Envio de Imagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Envio de Documentos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados": {
      "main": [
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisa Imagem": {
      "main": [
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcreve √Åudio": {
      "main": [
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message": {
      "main": [
        [
          {
            "node": "Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envio de Documentos": {
      "main": [
        [
          {
            "node": "Converter Arquivo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code_Split": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Mensagem WhatsApp": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bloquear Thread": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code_Split",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateEvent": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "GetEvents": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "DeleteEvent": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "UpdateEvents": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-15T14:42:47.075Z",
  "id": "sJTzaZaCX8D9ArVb",
  "isArchived": false,
  "meta": null,
  "name": "Agendamento SDR",
  "nodes": [
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Vari√°veis').item.json.sender }}_ai_messages_v4",
        "messageData": "={{ $json.sentence }}"
      },
      "id": "fa2fdbb2-c3b4-4517-bc06-00a710789791",
      "name": "AI Message Buffer",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        4680,
        400
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "bxkrGOk1aAsV5H0P",
          "mode": "list",
          "cachedResultName": "Intera√ß√£o Humana"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        120,
        180
      ],
      "id": "488cd86f-5180-4f86-9417-3dbbbb4a1a39",
      "name": "Bloquear Thread"
    },
    {
      "parameters": {
        "content": "# Interven√ß√£o Humana \n### Se a mensagem for manual, bloqueia mensagens da automa√ß√£o por TTL \nTTL = Segundos\n60 = 1 Min\n900 = 15 Min",
        "height": 520,
        "width": 619
      },
      "id": "3585c5b2-be88-42ab-bda6-27fcbc68440c",
      "name": "Sticky Note7",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.block }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "empty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA PODE RESPONDER"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "3ef0e01c-cc14-4663-bb4d-2905b350c3ab",
                    "leftValue": "={{ $json.block }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IA NAO PODE RESPONDER"
            }
          ]
        },
        "options": {}
      },
      "id": "11c70b3c-a6c1-4489-a14c-9278998141fc",
      "name": "Switch Block",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        360,
        360
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "block",
        "key": "={{ $('Vari√°veis').item.json.sender }}_block_v0",
        "options": {}
      },
      "id": "8e900970-bd52-41d2-a441-d393391654f5",
      "name": "Get Block Chat Id",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        100,
        360
      ]
    },
    {
      "parameters": {
        "content": "# Filtro\n## Remove mensagens do pr√≥prio rob√¥\n",
        "height": 380,
        "width": 300,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -320,
        140
      ],
      "id": "2c2f69b1-0d67-4131-87dd-f781c492850e",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "# Agendador Ninja\n",
        "height": 600,
        "width": 740,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3000,
        220
      ],
      "id": "d56faba3-9b3d-4265-b220-40ee1f6ab802",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "# Tags\n### Cria tags para pesquisa na aba Executions",
        "height": 340,
        "width": 220,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4040,
        220
      ],
      "id": "115bf6c2-fbdb-4c1f-83e1-3678dc7e32d5",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# Loop\n### Entrega as mensagens em ordem, com um intervalo aleat√≥rio entre elas.\n",
        "height": 440,
        "width": 1080
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4300,
        220
      ],
      "id": "74a24001-b994-43f0-8491-76785984a547",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# Split\n### Quebra mensagem em mensagens menores\n",
        "height": 340,
        "width": 220,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3760,
        220
      ],
      "id": "5f7354d0-860a-46b1-ae6d-d1784fe2ce0f",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Debounce\nConcatena mensagens quebradas",
        "height": 380,
        "width": 1120,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1860,
        220
      ],
      "id": "c0393597-804a-4238-980b-667bb2212d06",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "amount": 3
      },
      "id": "3a06a2b6-0582-44ae-b4ac-88ce5d969067",
      "name": "Wait2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2140,
        360
      ],
      "webhookId": "af58d366-140d-424d-9e26-25a4bbd54030"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Vari√°veis').item.json.sender }}_debounce"
      },
      "id": "4c079a7b-9959-43be-b4e3-bd904e2b1883",
      "name": "Clear Buffer",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2840,
        340
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "9e9b4155-e399-4936-a5db-2d79c8cb871f",
              "leftValue": "={{ $json.mensagem?.last() || \" \"}}",
              "rightValue": "={{ $('Message').item.json.mensagem }}",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0997b89e-d683-464d-bfa7-b77f9c33ce84",
      "name": "If no new messages",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2560,
        360
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagem",
        "key": "={{ $('Vari√°veis').item.json.sender }}_debounce",
        "options": {}
      },
      "id": "4b082169-fd59-4945-acaa-56c2a42cd7e1",
      "name": "Get Buffer Messages",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2340,
        360
      ]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Vari√°veis').item.json.sender }}_debounce",
        "messageData": "={{ $('Message').item.json.mensagem }}",
        "tail": true
      },
      "id": "f1bac37c-82ca-4290-91a7-2062b3feb35a",
      "name": "Buffer",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1940,
        360
      ]
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "type",
              "value": "Message"
            },
            {
              "key": "sender",
              "value": "={{ $('Vari√°veis').item.json.sender }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1,
      "position": [
        4100,
        380
      ],
      "id": "3f125e1b-ac1e-4b20-ba3d-87a59b0020f0",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Vari√°veis').item.json.sender }}_wapp",
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.4,
      "position": [
        3280,
        520
      ],
      "id": "5e3291e1-0875-486d-bdec-f80bdb39b006",
      "name": "Redis Chat Memory"
    },
    {
      "parameters": {
        "amount": "={{ Math.floor(Math.random() * 2) + 1 }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4880,
        400
      ],
      "id": "24c2aa49-86a2-425f-83f4-9057a6a4bb54",
      "name": "Wait1",
      "webhookId": "84b1cba7-e5ae-4526-9e91-26880cf50ff3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4420,
        380
      ],
      "id": "ba3cb81e-97c5-4682-9beb-5f1b52a63be7",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "7883d2e9-3b4d-4fad-a1b9-0a7fb3187911",
              "leftValue": "={{ $('Vari√°veis').item.json.fromMe }}",
              "rightValue": "=true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        300
      ],
      "id": "81fac2b8-675a-4faa-9590-13161374f44b",
      "name": "Remover From Me"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "d74b7c3b-68fb-410f-86fa-96c92174757f",
        "options": {}
      },
      "id": "e8c547ea-c1b4-479d-be40-af8857d8c51e",
      "name": "Webhook - Follow-Up",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1060,
        300
      ],
      "webhookId": "d74b7c3b-68fb-410f-86fa-96c92174757f"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "22f6820c-81c2-4cb4-8160-3bc4bbf1f466",
              "name": "baseUrl",
              "value": "={{ $json.body.server_url }}",
              "type": "string"
            },
            {
              "id": "f609d7fb-a996-431a-acc7-a0e90cf23b07",
              "name": "apikey",
              "value": "={{ $json.body.apikey }}",
              "type": "string"
            },
            {
              "id": "fe0f2951-e077-4529-bcfe-f5db97d6c137",
              "name": "messageType",
              "value": "={{ (() => {\n  const msg = $json.body?.data?.message;\n  const type = $json.body?.data?.messageType;\n  if (msg?.audioMessage) return 'audioMessage';\n  if (msg?.extendedTextMessage) return 'extendedTextMessage';\n  if (msg?.conversation) return 'conversation';\n  if (msg?.imageMessage) return 'imageMessage';\n  if (type === 'documentMessage') return 'documentMessage';\n  return null;\n})() }}",
              "type": "string"
            },
            {
              "id": "5feb35fb-5cec-4ba9-be2a-81fade540e62",
              "name": "instance",
              "value": "={{ $json.body.instance }}",
              "type": "string"
            },
            {
              "id": "94d910d7-11ae-412f-a6da-ee5ce4062330",
              "name": "sender",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "ead537ac-5605-40af-b815-cfd77fce3971",
              "name": "fromMe",
              "value": "={{ $json.body.data.key.fromMe }}",
              "type": "string"
            },
            {
              "id": "e5f1c0c4-a085-41ac-a857-169a5c8f36a7",
              "name": "message",
              "value": "={{ (() => {   \nconst msg = $json.body?.data?.message;   \nconst type = $json.body?.data?.messageType;    \nif (msg?.audioMessage?.url) return msg.audioMessage.url;   \nif (msg?.extendedTextMessage?.text) return msg.extendedTextMessage.text;   \nif (msg?.conversation) return msg.conversation;   \nif (msg?.imageMessage) return msg.imageMessage;   \nif (type === 'documentMessage' && msg?.documentMessage) return msg.documentMessage;    \nreturn null; })() }}",
              "type": "string"
            },
            {
              "id": "b6fe89d1-84a7-45e7-8994-a9af458c7501",
              "name": "messageId",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "69bf1d20-eff1-4e68-8da1-47a93c8bcb80",
      "name": "Vari√°veis",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -780,
        300
      ],
      "notesInFlow": false
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "messageType",
              "value": "={{ $json.messageType }}"
            },
            {
              "key": "fromMe",
              "value": "={{ $json.fromMe }}"
            },
            {
              "key": "message",
              "value": "={{ $json.message }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1,
      "position": [
        -540,
        300
      ],
      "id": "84ba54c5-2c82-4deb-a90f-0c4629e9cdf3",
      "name": "Execution Data2"
    },
    {
      "parameters": {
        "content": "# Processa Mensagens\n### Transcreve √Åudio, imagens e documentos",
        "height": 841,
        "width": 870,
        "color": 5
      },
      "id": "541182e9-3216-4114-9c44-2c895de02f43",
      "name": "Sticky Note13",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        640,
        0
      ],
      "disabled": true
    },
    {
      "parameters": {
        "content": "# Webhook\n## Recebe mensagens",
        "height": 380,
        "width": 300,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1160,
        140
      ],
      "id": "2e40529f-6e1e-42c7-afd0-26bc7b5db612",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Vari√°veis\n### Cria vari√°veis e adiciona √° execu√ß√£o",
        "height": 380,
        "width": 500
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -840,
        140
      ],
      "id": "c7076238-02c6-46ca-b7b1-784e6a9687de",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Vari√°veis').item.json.baseUrl }}/chat/getBase64FromMediaMessage/{{ $('Vari√°veis').item.json.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Vari√°veis').item.json.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"message\": {\n        \"key\": {\n            \"id\":  \"{{ $('Vari√°veis').item.json.messageId }}\"\n        }\n    },\n    \"convertToMp4\": true\n} ",
        "options": {}
      },
      "id": "bf697f68-b987-435f-b127-6d337597d5c7",
      "name": "Mensagem de Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        980,
        160
      ],
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {
          "fileName": "audio",
          "mimeType": "={{ $json.mimetype }}"
        }
      },
      "id": "54e29507-ed6b-40e7-93dd-34059c481522",
      "name": "Converter √Åudio",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1140,
        160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Vari√°veis').item.json.baseUrl }}/chat/getBase64FromMediaMessage/{{ $('Vari√°veis').item.json.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Vari√°veis').item.json.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"message\": {\n        \"key\": {\n            \"id\":  \"{{ $('Vari√°veis').item.json.messageId }}\"\n        }\n    },\n    \"convertToMp4\": true\n} ",
        "options": {}
      },
      "id": "6d759482-0f23-4e88-bc23-9e76c76d096c",
      "name": "Envio de Imagens",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        980,
        460
      ],
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {
          "fileName": "image",
          "mimeType": ""
        }
      },
      "id": "0ce7fa40-2103-4468-bfaf-532b1f549d8d",
      "name": "Converter Imagem",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1140,
        460
      ]
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "702c7c5e-c963-43ff-b775-f5d5082889ff",
      "name": "Extrair Dados",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1300,
        640
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {
          "fileName": "=image {{ $('Switch').item.json.body.data.message.documentMessage.fileName }}",
          "mimeType": "={{ $('Switch').item.json.body.data.message.documentMessage.mimetype }}"
        }
      },
      "id": "0f43ecbf-d517-45b0-819b-abe1776e3711",
      "name": "Converter Arquivo1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1140,
        640
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "101c3ff7-e997-43bb-8e99-fe82746c5993",
                    "leftValue": "={{ $('Vari√°veis').item.json.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audioMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "4b94d2ac-53e5-4153-9377-4cc6db20cb1c",
                    "leftValue": "={{ $('Vari√°veis').item.json.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "extendedTextMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "38226af4-80fe-4155-9ceb-2379f44e29ed",
                    "leftValue": "={{ $('Vari√°veis').item.json.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "conversation"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "300366d9-2416-4cf4-93c3-e48c8761c60f",
                    "leftValue": "={{ $('Vari√°veis').item.json.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imageMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "f33566fd-3eb9-45f4-934a-3a39e2adca6c",
                    "leftValue": "={{ $('Vari√°veis').item.json.messageType }}",
                    "rightValue": "documentMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "documentMessage"
            }
          ]
        },
        "options": {
          "fallbackOutput": "none"
        }
      },
      "id": "3e0ffbe3-2359-4dd9-b872-852623052ef8",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        660,
        300
      ]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "58ab47f2-31c1-4dab-9402-af9650fa27fe",
      "name": "Transcreve √Åudio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        1300,
        160
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Descreva essa imagem, o que tem nela?",
        "inputType": "base64",
        "options": {}
      },
      "id": "c5fe0b40-5e8d-4050-90e1-fd9ac9133ed7",
      "name": "Analisa Imagem",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        1300,
        460
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "491a978a-fe39-4154-bfac-f545eecc88a5",
              "name": "mensagem",
              "value": "={{ $json.text ?? $json.content ?? $('Vari√°veis').item.json.message }}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1640,
        400
      ],
      "id": "efc6765c-39d3-45bf-b5aa-149699fa7e27",
      "name": "Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Vari√°veis').item.json.baseUrl }}/chat/getBase64FromMediaMessage/{{ $('Vari√°veis').item.json.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Vari√°veis').item.json.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"message\": {\n        \"key\": {\n            \"id\":  \"{{ $('Vari√°veis').item.json.messageId }}\"\n        }\n    },\n    \"convertToMp4\": true\n} ",
        "options": {}
      },
      "id": "412027e5-51d2-4ff7-b468-9573f581e81d",
      "name": "Envio de Documentos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        960,
        640
      ],
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "content": "## Define conte√∫do da mensagem",
        "height": 360,
        "width": 300
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1540,
        240
      ],
      "id": "e040e148-cc68-4d08-80f4-9ec0609952bc",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "jsCode": "// Retrieve text input from the previous node\nconst text = $input.first().json.output;\n\n// Check if text exists and is a string\nif (!text || typeof text !== 'string') {\n  throw new Error(\"Invalid input: Expected a string in $input.first().json.output\");\n}\n\n// Clean text: Remove quotes but keep structure intact\nlet cleanedText = text.replace(/[\"']/g, '');\n\n// Replace all occurrences of **text** with *text*\ncleanedText = cleanedText.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\n\n// Split strictly on newlines (\\n or \\r\\n)\nconst sentences = cleanedText.split(/\\r?\\n/).map(line => line.trim()).filter(line => line);\n\n// Format the output as an array of objects\nreturn sentences.map(sentence => ({ sentence }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3820,
        380
      ],
      "id": "48a845bb-884d-4bb2-a266-d3a175ef642b",
      "name": "Code_Split",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Vari√°veis').item.json.baseUrl }}/message/sendText/{{ $('Vari√°veis').item.json.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Vari√°veis').item.json.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Vari√°veis').item.json.sender }}\",\n  \"text\": \"{{ $json.sentence }}\"\n}\n",
        "options": {}
      },
      "id": "4f0354c4-4bb3-406b-992b-82565eb25fdf",
      "name": "Enviar Mensagem WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        5120,
        400
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "publish",
        "channel": "={{ $('Vari√°veis').item.json.sender }}_wapp",
        "messageData": "={{ $('Vari√°veis').item.json.message }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        360,
        180
      ],
      "id": "ea51e118-ef9e-4866-84e8-59d1ce54bfc9",
      "name": "Redis"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Get Buffer Messages').item.json.mensagem.join(\" \") }}",
        "options": {
          "systemMessage": "=Este assistente virtual foi criado para proporcionar um suporte eficiente e amig√°vel para agendamentos e cancelamentos de reuni√µes na Ninja das Harmoniza√ß√µes, especializada em harmoniza√ß√£o facial. Ele auxilia os clientes a visualizar hor√°rios dispon√≠veis, agendar consultas personalizadas e obter detalhes completos sobre os servi√ßos oferecidos.\n\nInforma√ß√µes da Empresa:\nNome: Ninja das Harmoniza√ß√µes - Especialista em Harmoniza√ß√£o Facial\n\nEndere√ßo: Rua dos Harmonizados, 1234 - Vila Bela, S√£o Paulo - SP, CEP 01234-100\n\nHor√°rio de Funcionamento:\n\nSegunda a sexta-feira: das 08:00 √†s 18:00\n\nS√°bado: das 08:00 √†s 12:00\n\nServi√ßos Dispon√≠veis e Valores:\nConsultoria Inicial: R$ 300\n\nHarmoniza√ß√£o Facial Personalizada: R$ 1.500\n\nAjuste de Preenchimento Facial: R$ 1.000\n\nAvalia√ß√£o e Otimiza√ß√£o de Procedimentos Est√©ticos: R$ 800\n\nOutros Servi√ßos: valor sob consulta\n\nFun√ß√µes do Assistente\n1. Exibir Hor√°rios Dispon√≠veis\n\nObjetivo: Mostrar os hor√°rios de consulta ou reuni√£o dispon√≠veis ao cliente, considerando um intervalo de datas informado, o fuso hor√°rio \"America/Sao_Paulo\" e o hor√°rio de funcionamento da Ninja das Harmoniza√ß√µes.\n\nEnvie no m√°ximo 5 hor√°rios por vez com base no per√≠odo (manh√£, tarde ou noite)\n\nCrit√©rios de Exibi√ß√£o:\n\nExibir apenas hor√°rios futuros a partir do momento atual.\n\nUtilizar o formato de data (DD/MM/AAAA) e hor√°rio (HH).\n\nN√£o solicitar o e-mail do cliente nesta etapa.\n\nConsiderar os hor√°rios de funcionamento da empresa.\n\nExemplo de Resposta:\n\nüìÖ Data Atual: {{ $now }}\n\nHor√°rios dispon√≠veis para hoje:\n\n‚è∞ 08:00\n\n‚è∞ 09:00\n\n‚è∞ 10:00\n\n‚è∞ 11:00\n(continuar a lista conforme disponibilidade...)\n\nPor favor, informe o hor√°rio desejado e o motivo da consulta (ex: Consultoria Inicial, Harmoniza√ß√£o Facial, Avalia√ß√£o de Procedimento, etc.) para prosseguir com o agendamento! üòä\n\n2. Solicitar Motivo da Reuni√£o\nAntes de realizar o agendamento, o assistente deve:\n\nPerguntar ao cliente o motivo da consulta. Exemplos incluem: Consultoria Inicial, Harmoniza√ß√£o Facial, Ajuste de Preenchimento Facial, Avalia√ß√£o de Procedimentos, entre outros.\n\nSomente ap√≥s o cliente informar o motivo, o assistente pode prosseguir para a etapa de confirma√ß√£o do agendamento.\n\n3. Confirmar Agendamento\nObjetivo: Confirmar o agendamento ap√≥s o cliente escolher um hor√°rio e informar o motivo da consulta.\n\nInstru√ß√µes:\n\nSe o hor√°rio selecionado for para o mesmo dia, confirmar o agendamento para \"hoje\".\n\nCaso seja uma data futura, incluir a data e o hor√°rio do agendamento na confirma√ß√£o.\n\nIncluir o nome do cliente e o motivo do agendamento no t√≠tulo do evento do Google Calendar, por exemplo: \"Consulta - Jo√£o Silva - Harmoniza√ß√£o Facial\".\n\nSolicitar o e-mail do cliente para envio do link do evento e confirma√ß√£o ap√≥s a sele√ß√£o do hor√°rio e motivo da reuni√£o.\n\nDados Necess√°rios: Nome, e-mail, data e hor√°rio do agendamento, motivo da consulta.\n\nExemplo de Resposta para Agendamento no Mesmo Dia:\n\n‚úÖ Agendamento confirmado para hoje √†s [hor√°rio escolhido]! üòä\n\nExemplo para Data Futura:\n\n‚úÖ Agendamento confirmado para [data escolhida] √†s [hor√°rio escolhido]! üòä\n\nDetalhes do seu agendamento:\n\nEndere√ßo: Rua dos Harmonizados, 1234 - Vila Bela, S√£o Paulo - SP\n\nData: [data escolhida]\n\nHor√°rio: [hor√°rio escolhido]\n\nMotivo da Reuni√£o: [motivo informado pelo cliente]\n\nLink do Evento: [incluir o link do Google Calendar]\n\nLembre-se de trazer materiais relacionados ao procedimento ou d√∫vidas espec√≠ficas, se aplic√°vel. Qualquer d√∫vida, estamos √† disposi√ß√£o! üòä\n\n4. Cancelar Agendamento\nObjetivo: Cancelar um agendamento mediante o fornecimento do e-mail do cliente.\n\nInstru√ß√µes:\n\nBuscar o evento com base no email do lead (pe√ßa o email caso nao souber) usando a tool GetEvents\n\nExcluir o evento usando a tool DeleteEvent usando a ID do evento\n\nConfirmar o cancelamento e informar o cliente com uma mensagem clara.\n\nDados Necess√°rios: E-mail de confirma√ß√£o.\n\nExemplo de Resposta de Cancelamento Bem-Sucedido:\n\n‚úÖ Agendamento cancelado com sucesso! üòä\n\nCaso deseje reagendar ou tenha alguma d√∫vida, estamos √† disposi√ß√£o!\n\nExemplo de Erro ao Cancelar:\n\n‚ö†Ô∏è Erro ao cancelar. Verifique o e-mail e tente novamente.\n\n\n5. Reagendamento\n\nObjetivo:Reagendar compromisso.\n\nInstru√ß√µes:\n\nBuscar o evento com base no email do lead (pe√ßa o email caso nao souber)  usando a tool GetEvents\n\nAtualizar o hor√°rio do evento usando a tool UpdateEvent usando a ID do evento\n\nConfirmar o reagendamento e informar o cliente com uma mensagem clara.\n\nDados Necess√°rios: E-mail de confirma√ß√£o.\n\nExemplo de Resposta de Reagendamento Bem-Sucedido:\n\nDetalhes do seu agendamento:\n\nEndere√ßo: Rua dos Harmonizados, 1234 - Vila Bela, S√£o Paulo - SP\n\nData: [data escolhida]\n\nHor√°rio: [hor√°rio escolhido]\n\nMotivo da Reuni√£o: [motivo informado pelo cliente]\n\nLink do Evento: [incluir o link do Google Calendar]\n\nLembre-se de trazer materiais relacionados ao procedimento ou d√∫vidas espec√≠ficas, se aplic√°vel. Qualquer d√∫vida, estamos √† disposi√ß√£o! üòä\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        3200,
        340
      ],
      "id": "452a250c-fc5b-4d6f-bc2f-16fc6aed60d0",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3160,
        540
      ],
      "id": "edcba1de-7af3-4e4d-90f1-944f7da214ac",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "bf29dace8e13bbec00ca49787e027134c97faa5f003a7abe6954eb858fe0d6ae@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Ninja"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', ``, 'string') }}",
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees1_Attendees', ``, 'string') }}"
          ],
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', ``, 'string') }}",
          "sendUpdates": "all",
          "summary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3320,
        700
      ],
      "id": "0b959de7-dee5-4afb-9da8-d604dfd3f47a",
      "name": "CreateEvent"
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "bf29dace8e13bbec00ca49787e027134c97faa5f003a7abe6954eb858fe0d6ae@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Ninja"
        },
        "returnAll": true,
        "timeMin": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3540,
        680
      ],
      "id": "8d84652e-11f6-428d-b015-772907759e2c",
      "name": "GetEvents"
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "bf29dace8e13bbec00ca49787e027134c97faa5f003a7abe6954eb858fe0d6ae@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Ninja"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3440,
        680
      ],
      "id": "de04ac38-a200-47a5-b7ad-37dfe4880a29",
      "name": "DeleteEvent"
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "bf29dace8e13bbec00ca49787e027134c97faa5f003a7abe6954eb858fe0d6ae@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Ninja"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "updateFields": {
          "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
          "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3640,
        680
      ],
      "id": "4c01d6da-19de-4c6b-a6ab-ec7c671addb1",
      "name": "UpdateEvents"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-06-15T14:42:47.075Z",
      "updatedAt": "2025-06-15T14:42:47.075Z",
      "role": "workflow:owner",
      "workflowId": "sJTzaZaCX8D9ArVb",
      "projectId": "o60HadikmqrvYZ9Z"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-06-14T14:35:30.743Z",
      "updatedAt": "2025-06-14T14:35:30.743Z",
      "id": "f7Ttu7FQN3EvRKX9",
      "name": "ü•∑üèº Ninja Automa√ß√µes"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-06-15T14:42:47.075Z",
  "versionId": "83e43efe-c59b-48d1-b4d6-0523877af8d4"
}