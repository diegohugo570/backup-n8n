{
  "active": false,
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Obtém Histórico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sintetiza Histórico": {
      "main": [
        [
          {
            "node": "Resume",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtém resumo anterior": {
      "main": [
        [
          {
            "node": "Sintetiza Histórico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Primeiro resumo?": {
      "main": [
        [
          {
            "node": "Cria resumo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualiza Resumo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtém Histórico": {
      "main": [
        [
          {
            "node": "Agrega as Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza Resumo": {
      "main": [
        [
          {
            "node": "Deleta Mensagens do Histórico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cria resumo": {
      "main": [
        [
          {
            "node": "Deleta Mensagens do Histórico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Deleta Mensagens do Histórico": {
      "main": [
        [
          {
            "node": "Obtém resumo das conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtém resumo das conversas": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrega as Mensagens": {
      "main": [
        [
          {
            "node": "Fazer resumo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fazer resumo?": {
      "main": [
        [
          {
            "node": "Obtém resumo anterior",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtém resumo das conversas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resume": {
      "main": [
        [
          {
            "node": "Primeiro resumo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-07T13:27:26.077Z",
  "id": "DiycYXbNCsVSMhMt",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Memória trim e resumo",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -2100,
        280
      ],
      "id": "d2bd2a9e-773d-4c40-9138-822d7adef48a",
      "name": "When chat message received",
      "webhookId": "3cb6d76b-4190-4134-84aa-997802b9631e"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "15561d3b-ff32-4ace-8f92-dd839ee25409",
              "name": "historico",
              "value": "={{ $if($json.isEmpty(), \"\", \"Resumo de conversas anteriores: \" + $json.summary + \"\\nNovas conversas:\") }}\n{{$('Fazer resumo?').item.json.data.map(m => `${m.message.type === \"human\" ? \"Usuário\" : \"Você\"}: ${m.message.content}`).join(\"\\n\")}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -780,
        140
      ],
      "id": "dd1bbebd-2d3a-4800-b9ab-5f035550d7d8",
      "name": "Sintetiza Histórico"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "n8n_chat_histories_summary",
        "filters": {
          "conditions": [
            {
              "keyName": "remoteJid",
              "keyValue": "={{ $json.data[0].session_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1000,
        140
      ],
      "id": "56321c0b-e9bc-4409-a395-5dd4333e5596",
      "name": "Obtém resumo anterior",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "77e12088-6d5c-4174-ba1f-6310ce04bae6",
              "leftValue": "={{ $('Obtém resumo anterior').item.json.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        140
      ],
      "id": "a0f1ef57-4e3c-4d8d-9ab2-2b975b94d825",
      "name": "Primeiro resumo?"
    },
    {
      "parameters": {
        "tableId": "n8n_chat_histories_summary",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "summary",
              "fieldValue": "={{ $json.message.content }}"
            },
            {
              "fieldId": "remoteJid",
              "fieldValue": "={{ $('Obtém Histórico').last().json.session_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "27835ea8-69a1-44d3-9e71-87bc9c6e7498",
      "name": "Cria resumo",
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "n8n_chat_histories_summary",
        "filters": {
          "conditions": [
            {
              "keyName": "remoteJid",
              "condition": "eq",
              "keyValue": "={{ $('Obtém Histórico').last().json.session_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "summary",
              "fieldValue": "={{ $json.message.content }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        0,
        220
      ],
      "id": "ea5d64a0-fc37-4109-a56a-832261d51a6d",
      "name": "Atualiza Resumo",
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "n8n_chat_trim",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "condition": "eq",
              "keyValue": "={{ $json.sessionId }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1780,
        280
      ],
      "id": "0b34271b-9c43-4847-9e25-498c3d29013a",
      "name": "Obtém Histórico",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When chat message received').item.json.chatInput }}",
        "options": {
          "systemMessage": "=Você é uma vendedora chamada Ana especialista em Spin Selling. Você tem o objetivo de me vender a formação arquiteto de IA do Anwar Hermuche, especialista em IA.\n\n\n# Contexto de conversa com esse usuário\n{{ $('Obtém resumo das conversas').item.json.summary }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        680,
        340
      ],
      "id": "d751a26f-63d5-4d2f-8e91-1829e7f834de",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        640,
        640
      ],
      "id": "84701aad-7254-4832-adee-42a3a398b25d",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "58nXg6cOh7QVFFh8",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When chat message received').item.json.sessionId }}",
        "tableName": "n8n_chat_trim"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        860,
        640
      ],
      "id": "a6e6aa03-4f35-4253-8e66-bf820dd5bb90",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "73jA7cX7eJ5q2zdy",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "n8n_chat_trim",
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "condition": "eq",
              "keyValue": "={{ $('Obtém Histórico').last().json.session_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        240,
        120
      ],
      "id": "334d1755-9d23-4d61-b1ac-87ef293a371b",
      "name": "Deleta Mensagens do Histórico",
      "alwaysOutputData": false,
      "executeOnce": false,
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "n8n_chat_histories_summary",
        "filters": {
          "conditions": [
            {
              "keyName": "remoteJid",
              "keyValue": "={{ $('When chat message received').first().json.sessionId }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        460,
        340
      ],
      "id": "0865d076-b085-4b2b-a06f-a22f4673ec2e",
      "name": "Obtém resumo das conversas",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "supabaseApi": {
          "id": "IbOICFLx28vkTb6x",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -1560,
        280
      ],
      "id": "407f2ea4-563e-4511-bd64-8ac17273b737",
      "name": "Agrega as Mensagens"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "42a03203-aeb7-4f66-875a-1e176b9b87b9",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "c47b3648-df86-43f3-a169-138f7e178fbb",
              "leftValue": "={{ $json.data }}",
              "rightValue": 10,
              "operator": {
                "type": "array",
                "operation": "lengthGte",
                "rightType": "number"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1340,
        280
      ],
      "id": "a8f49b2b-ec56-4f62-a645-6836e1d16ce1",
      "name": "Fazer resumo?"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.historico }}"
            },
            {
              "content": "=<cargo>\n  Você é especialista em Resumos de Conversas. Sua função é analisar e resumir conversas de modo profissional, utilizando técnicas avançadas de síntese para capturar cada nuance e detalhe essencial, mas apresentando tudo em um único parágrafo, direto ao ponto, com máxima densidade informacional.\n</cargo>\n\n<contexto>\n  Você recebe transcrições completas de conversas que podem abordar temas técnicos, negociações, decisões estratégicas, conflitos, orientações de equipes, brainstormings ou acompanhamentos de projetos. O público-alvo do seu resumo é composto por gestores, stakeholders e equipes que não participaram da conversa, mas precisam entender rapidamente tudo que foi tratado, decidido, questionado e o contexto de cada fala relevante, sem ter acesso ao conteúdo original.\n</contexto>\n\n<instruções>\n  1. Leia toda a conversa de forma minuciosa, identificando: principais tópicos debatidos, decisões finais e intermediárias, tarefas atribuídas, prazos, objeções levantadas, sugestões, argumentos, motivações, nomes de pessoas envolvidas, informações quantitativas (valores, datas, métricas), dúvidas levantadas e respondidas, pendências e próximos passos.\n  2. Capte e registre no resumo qualquer mudança de tom (cordial, tensa, hesitante, assertiva), discordância relevante, reviravolta, conflito, acordo parcial, concessão, apontamento de riscos, hesitações, justificativas técnicas, priorização de tarefas ou pontos não resolvidos.\n  3. Produza o resumo em UM ÚNICO PARÁGRAFO, enxuto, direto, sem listas ou bullets, SEM redundância, mantendo a sequência lógica dos fatos e ações, detalhando o suficiente para que uma pessoa externa compreenda o contexto, o que foi tratado, quem participou, as decisões, os conflitos, os resultados, os prazos, os próximos passos e as possíveis pendências, SEM qualquer interpretação ou opinião pessoal.\n  4. Preserve o máximo de informação objetiva por palavra, usando frases curtas, estruturadas e densas, SEM floreios, adjetivos vagos, repetições ou contextualização superficial. Registre toda informação crítica, evitando omissões, mesmo em detalhes pontuais que possam influenciar decisões ou estratégias futuras.\n  5. Inclua no resumo qualquer citação ou frase-chave que denote alinhamento, discordância, mudança de rumo ou comprometimento explícito, atribuindo nomes quando possível.\n  6. Em caso de múltiplos temas, conecte todos com clareza no mesmo parágrafo, usando pontuação adequada e mantendo a ordem cronológica dos eventos.\n  7. Não omita: nomes, datas, métricas, tarefas, responsáveis, acordos, divergências e justificativas relevantes.\n  8. O resultado final deve ser um parágrafo único, completo, com densidade máxima de detalhes e clareza, atendendo o leitor que precisa captar o conteúdo integral da conversa em menos de 30 segundos.\n</instruções>\n\n<raciocinio>\n  Antes de escrever, anote para si: quais os objetivos da conversa, quais decisões, tarefas, datas, valores ou conflitos não podem faltar? Houve algum ponto polêmico, ajuste de estratégia, definição de responsáveis, pendências ou alinhamento de expectativas? Elimine tudo que não for relevante, mas garanta que nenhuma nuance importante fique de fora do parágrafo. Use o método RICES: Recolha o máximo de informação útil, Integre os tópicos de modo coeso, Contextualize de forma precisa, Extraia as decisões e ações centrais e Sintetize tudo no parágrafo mais objetivo possível.\n</raciocinio>\n\n<exemplo>\n  Durante a reunião de 03/07/2025 entre João, Carla e Marcos, discutiu-se a entrega do projeto X, com Carla sugerindo antecipar o prazo para 15/07, João discordando devido a limitações técnicas detalhadas e Marcos propondo realocação de recursos; após breve debate, ficou decidido manter a data original de 22/07, com possibilidade de revisão caso surjam atrasos, João ficou responsável pela análise de gargalos até dia 05/07, Carla comprometeu-se a enviar relatório até 04/07 e Marcos alinhou uma revisão técnica extra; houve breve tensão na discussão do orçamento, sem consenso final, ficando pendente uma nova rodada de negociação para semana seguinte.\n</exemplo>\n\n<lembre-se>\n  Sempre produza o resumo em UM PARÁGRAFO ÚNICO, sem listas, mantendo máxima objetividade, densidade informacional e clareza, sem perder nenhuma nuance ou detalhe relevante da conversa original. Não inclua sua opinião, julgamento ou contextualização superficial. O leitor deve captar rapidamente o cenário, o que mudou, quem decidiu, quem discordou, o que ficou pendente e os próximos passos, com detalhes de datas, tarefas e nomes.\n\nO parágrafo deve ter, no máximo, 550 caracteres. Nada além disso.\n</lembre-se>",
              "role": "system"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -600,
        140
      ],
      "id": "e3acbfc7-adf8-4539-bee8-d43f7ea51ee9",
      "name": "Resume",
      "credentials": {
        "openAiApi": {
          "id": "58nXg6cOh7QVFFh8",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-07-07T13:28:04.107Z",
  "versionId": "2324ddfc-7b16-49b6-85c2-61f67e6a92b5"
}